---
title: "Climate Analysis"
output: html_notebook
---

R download climate data from ECCC (for antler paper)

Need data from 2016-2024 for Twillingate AUT (Station ID = 7083, Climate ID = 8404025), hourly/daily.monthly data available
note: Twillingate station is not in use (was in the 1960s)

janky documentation for the API https://drive.google.com/drive/folders/1WJCDEU34c60IfOnG4rv5EPZ4IhhW9vZH
Or use weathercan package from ropenSci

Do not need to run this everytime.
```{r twillingate data, eval = false}
library(weathercan)
stations_dl()
twillingate <- weather_dl(station_ids = 7083, start = "2016-01-01", end = "2024-12-31")

#write.csv(twillingate, "twillingate_weather.csv")
```

visualize the weather changes per year
```{r data prep, include = FALSE}
library(tidyverse)
library(mgcv)
library(ggplot2)
library(nlme)
library(gratia)

twillingate <- read.csv('../data/twillingate_weather.csv')

monthly_data<-twillingate %>% 
  select(c(12:17,21,23,25,27,28,33,35,37)) %>% 
  group_by(year, month) %>% 
  summarize(precip_avg = mean(precip_amt, na.rm = F), precip_max = max(precip_amt, na.rm = F), precip_min = min(precip_amt, na.rm = F), temp_avg = mean(temp, na.rm = F), temp_max = max(temp, na.rm = F), temp_min = min(temp, na.rm = F), .groups = "drop") %>% 
  mutate(date = with(., sprintf("%d-%02d", year, month)), time =`year` - 2024, month = as.integer(month), year = as.integer(year)) %>% #not in date format...
  filter_if(~is.numeric(.), all_vars(!is.infinite(.)))

#There is probably a better way to apply this to all these columns, mapply?
#add time as a trend variable
daily_data <- twillingate %>% 
  select(c(12:17,21,23,25,27,28,33,35,37)) %>% 
  group_by(year, month, day) %>% 
  summarize(precip_avg = mean(precip_amt, na.rm = F), precip_max = max(precip_amt, na.rm = F), precip_min = min(precip_amt, na.rm = F), temp_avg = mean(temp, na.rm = F), temp_max = max(temp, na.rm = F), temp_min = min(temp, na.rm = F), .groups = "drop") %>% 
  mutate(date = as.Date(with(., paste(year,month,day, sep = '-'))), j_date = as.numeric(format(date, "%j")), time =`year` - 2024, month = as.integer(month), day = as.integer(day), year = as.integer(year)) %>% 
  filter_if(~is.numeric(.), all_vars(!is.infinite(.)))
```



```{r monthly weather}
ggplot(monthly_data, aes(as.factor(month), temp_avg, color = year)) + geom_point()

ggplot(monthly_data, aes(x = date)) + geom_line(aes(y = temp_avg, group = 1)) + geom_line(aes(y = temp_max, group = 1, colour = "red")) + geom_line(aes(y = temp_min, group = 1, colour = "blue"))

#all years on same axes, monthly data
ggplot(monthly_data) + geom_line(aes(x = month, y = temp_avg, colour = factor(year))) +
  scale_x_continuous(breaks = 1:12, labels = month.abb, minor_breaks = NULL) +
  labs(colour = "Year", y = "Average Monthly Temperature", x = "Month") + scale_color_brewer(palette="RdBu", direction=-1)
```


```{r daily weather data}
#plot avg daily temp per year and look for differences
#this is the data we want but it's very hard to compare all the years at once with daily data
ggplot(daily_data) + geom_line(aes(x = j_date, y = temp_avg, colour = factor(year))) + scale_color_brewer(palette="RdBu", direction=-1) + scale_x_continuous(breaks = seq(1, 365, by = 30)) + labs(colour = "Year", y = "Average Daily Temperature", x = "Julian Calendar Day")

#Do I need to more appropriately smooth this? 
ggplot(daily_data) + geom_smooth(aes(x = j_date, y = temp_avg, colour = factor(year)), se = F) + scale_color_brewer(palette="RdBu", direction=-1) + scale_x_continuous(breaks = seq(1, 365, by = 30)) + labs(colour = "Year", y = "Average Daily Temperature", x = "Julian Calendar Day")

#2024 has really low precipitation as well as higher temp but 2021 only has higher temp
ggplot(daily_data) + geom_smooth(aes(x = j_date, y = precip_avg, colour = factor(year)), se = F) + scale_color_brewer(palette="RdBu", direction=-1) + scale_x_continuous(breaks = seq(1, 365, by = 30)) + labs(colour = "Year", y = "Average Daily Precipitation", x = "Julian Calendar Day")

#facet by year and look at october to calving or jan to calving, 

```

Fitting a gamm to this data to investigate changes between years. Focus on 2023/2024 calving season where we observed abnormal antler growth timing.

```{r gamm data prep}
# Load the dataset (Ensure the file path is correct)
calving_season_data <- read.csv("twillingate_weather.csv")

# Ensure date columns are properly formatted
calving_season_data$date <- as.Date(with(calving_season_data, paste(year, month, day, sep="-")), "%Y-%m-%d")

# Assign calving season variable
calving_season_data$calving_season <- ifelse(calving_season_data$month >= 11,
                                             paste(calving_season_data$year, calving_season_data$year + 1, sep="/"),
                                             paste(calving_season_data$year - 1, calving_season_data$year, sep="/"))

# Convert calving season to a factor and set 2022/2023 as the reference level
calving_season_data$calving_season <- factor(calving_season_data$calving_season, 
                                             levels = c("2023/2024", sort(unique(calving_season_data$calving_season[calving_season_data$calving_season != "2023/2024"]))))

# Filter for relevant months (Nov–May)
calving_season_data <- subset(calving_season_data, month %in% c(11, 12, 1, 2, 3, 4, 5))

# Aggregate data to daily values with mean, min, and max temperature
calving_season_daily <- calving_season_data %>%
  group_by(date, calving_season) %>%
  summarise(mean_temp = mean(temp, na.rm = TRUE),
            min_temp = min(temp, na.rm = TRUE),
            max_temp = max(temp, na.rm = TRUE),
            precip_amt = sum(precip_amt, na.rm = TRUE),
            .groups = 'drop') %>% 
  filter(!calving_season %in% c("2015/2016", "2024/2025")) #remove incomplete seasons

# Create day of season variable
calving_season_daily <- calving_season_daily %>%
  group_by(calving_season) %>%
  arrange(date) %>%
  mutate(day_of_season = row_number()) %>%
  ungroup()

```


Fit a gamm model with an interaction between year (calving_season) and time throughout the winter (day_of_season, count of days starting nov 1 to may 31)
```{r Gamm temp}
# Fit a Generalized Additive Mixed Model (GAMM) with AR(1) autocorrelation within calving season
gam_model <- gamm(mean_temp ~ s(day_of_season, by=calving_season) + precip_amt + calving_season, 
                  data = calving_season_daily, 
                  family = gaussian(), 
                  correlation = corAR1(form = ~ day_of_season | calving_season), 
                  method = "REML")

# Summary of the model
summary(gam_model$gam)
```


```{r visualizations}
# Post-hoc test to compare smooth trends across calving seasons
sm_diff <- difference_smooths(gam_model$gam, select = "s(day_of_season)", ci = 0.95)
sm_diff <- sm_diff %>% 
  filter(.level_1 == "2023/2024" | .level_2 == "2023/2024") %>% #only relevant comparisons
  filter(!.level_1 %in% c("2019/2020", "2020/2021") & !.level_2 %in% c("2019/2020", "2020/2021")) %>% 
  mutate(colour_code = )
draw(sm_diff)
# Visualization of modeled temperature trends across calving seasons
plot_data <- expand.grid(
  day_of_season = seq(1:212),
  calving_season = unique(calving_season_daily$calving_season),
  precip_amt = mean(calving_season_daily$precip_amt, na.rm = TRUE))

plot_data <- plot_data %>% 
  mutate(predicted_temp = 
           predict(gam_model$gam, newdata = plot_data, type = "response")) %>% 
  filter(!calving_season %in% c("2019/2020", "2020/2021"))

ggplot(calving_season_daily, aes(x = day_of_season, y = mean_temp, color = calving_season)) +
  #scale_color_manual(values = c("2023/2024" = "darkcyan", "2022/2023" = "pink", "2021/2022" = "salmon", "2018/2019" = "coral", "2017/2018" = "tomato", "2016/2017" = "firebrick")) +
  #geom_point(alpha = 0.3) +
  geom_line(data = plot_data, aes(x = day_of_season, y = predicted_temp), size = 1) +
  scale_x_continuous(breaks = c(1, 31, 62, 93, 121, 151, 182), labels = c('Nov', 'Dec', 'Jan', 'Feb', 'Mar', 'Apr', 'May')) +
  labs(x = "Month", y = "Mean Temperature (°C)",
       title = "Modeled Temperature Trends Across Calving Seasons") +
  theme_minimal()

```

thoughts:

all estimates are negative when compared to the abnormal year, indicating that year was warmer. However, the two more recent years (2021/2022, 2022/2023) were not significantly cooler. However they are cooler from januiary to the beginning of may like the other years.

There's some interpretation for the diff plots as well, based on the time of year and when the abnormal year is warmer or cooler. Specific pairwise comparisons to try to find the common ground for years with normal growth and the year without. This would need to be reported cautiously though as we only have one year of abnormal data. I have also excluded the two years we don't have observational data from since we don't know what happened those years.

Maybe look into changes in habitat selection and variability in temperature, or just habitat selection and average temperature?

Trying to add variance to the story.
I think the final piece of this that we could add is about the variability in temperature. Is it an absolute temperature that triggers antler loss and growth, or do fluctuating temperatures interrupt this mechanistic pathway either with confusing singnals/cues or through stress.
these are too coarse at the mean level maybe, should do daily variation (max-min temp? or just sd)

```{r variability}
library(lme4)

# Calculate variability metrics for each winter
winter_variability <- twillingate %>%
  filter(year %in% c(2016:2024)) %>% 
  filter(month %in% c(11:12, 1:5)) %>%  # Filter for winter months
  group_by(year, month, day) %>%
  summarise(
    mean_temp = mean(temp, na.rm = TRUE),
    sd_temp = sd(temp, na.rm = TRUE),  # Standard deviation
    range_temp = max(temp, na.rm = TRUE) - min(temp,na.rm = TRUE),  # Range
    iqr_temp = IQR(temp, na.rm = TRUE)  # Interquartile range
  )

# Line plot of standard deviation over time, visualization is janky
#broken
ggplot(winter_variability, aes(x = month, y = sd_temp, group = as.factor(year), color = as.factor(year))) +
  geom_boxplot() +
  labs(
    title = "Standard Deviation of Winter Temperatures Over Time",
    x = "Month",
    y = "Standard Deviation"
  ) +
  theme_minimal()
```

variance tests. Levene test is an assessment of the homogeneity of variance, but is basically an ANOVA on the residuals. There's no posthoc test, so I'll pull out the residuals and use those to test differences.
```{r variance test}
library(car)
leveneTest(mean_temp ~ as.factor(year), winter_variability, center=mean) # sig
hist(winter_variability$mean_temp)

#trying for a post-hoc group comparison since there is not homogeneity of variance
#but I don't think this is the best way to test this, so maybe a gamm with sd as response
winter_variability <- winter_variability %>% 
  group_by(year) %>% 
  mutate(dat.mean = ifelse(mean_temp, mean(mean_temp, na.rm=TRUE), ifelse(is.na(dat), NA)))

#calculate residuals from the winter mean temperature
winter_variability$dat.res<-abs(winter_variability$mean_temp-winter_variability$dat.mean)

levene.dat.aov<-aov(dat.res ~ as.factor(year) + as.factor(month), winter_variability)
summary(levene.dat.aov)
TukeyHSD(levene.dat.aov)

#but I don't think this is the best way to test this, so maybe a gamm with sd as response
```

maybe we model sd with a Gamm? GAM model not working right now.... and idk why

is this where we do a DHGLMM??????

Could also do a simpler analysis with a coefficient of variation by day and month for temperatures and see if they vary by year or month with an anova/mixed model.
```{r gam of variability}
variance_model <- gam(sd_temp ~ s(year) + s(month, by = year), data = winter_variability, method = "REML")
summary(variance_model)
plot(variance_model, shade = TRUE)
```

